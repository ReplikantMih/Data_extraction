!function(t){t.fn.vishnu.VishnuEvent.MODE_CHANGE="vishnu-mode-change",t.fn.vishnu.VishnuEvent.SWITCH_TO_OPERATOR_REQUESTED="nns_switchToOperatorRequested",t.fn.vishnu.VishnuEvent.LIVECHAT_STATUS_REQUESTED="nns_livechatStatusRequested",t.fn.vishnu.VishnuEvent.LIVECHAT_SESSION_CREATED="nns_livechatSessionCreated",t.fn.vishnu.VishnuEvent.OPERATOR_PERSON_ASSIGNED="nns_operatorPersonAssigned",t.fn.vishnu.VishnuEvent.QUEUE_TIMED_OUT="nns_queueTimedOut",t.fn.vishnu.VishnuEvent.LOG_TO_OPERATOR_SENT="nns_logToOperatorSent",t.fn.vishnu.VishnuEvent.V3G_LOG_TO_OPERATOR_SENT="v3g_logToOperatorSent",t.fn.vishnu.VishnuEvent.SWITCH_TO_OPERATOR_SUCCESS="nns_switchToOperatorSuccess",t.fn.vishnu.VishnuEvent.USER_TYPED="nns_userTyped",t.fn.vishnu.VishnuEvent.USER_TEXT_SENT="nns_userTextSent",t.fn.vishnu.VishnuEvent.OPERATOR_TYPED="nns_operatorTyped",t.fn.vishnu.VishnuEvent.OPERATOR_TEXT_SENT="nns_operatorTextSent",t.fn.vishnu.VishnuEvent.USER_END_DIALOG="nns_userEndDialog",t.fn.vishnu.VishnuEvent.SWITCH_TO_VISHNU="nns_switchToVishnu",t.fn.vishnu.VishnuEvent.V3G_OPERATOR_CHAT_RATED="v3g_operatorChatRated",t.fn.vishnu.VishnuEvent.OPERATOR_CHAT_RATED="nns_operatorChatRated",t.fn.vishnu.VishnuEvent.OPERATOR_MESSAGE_RATED="nns_operatorMessageRated",t.fn.vishnu.VishnuEvent.FILE_UPLOAD_EXTERNAL_PROCESS="nns_fileUploadExternalProcess",t.fn.vishnu.VishnuEvent.FILE_UPLOADED="nns_fileUploaded",t.fn.vishnu.VishnuEvent.V3G_UPLOAD_EXTERNAL_PROCESS="v3g_logUploadExternalProcess",t.fn.vishnu.VishnuEvent.LOG_UPLOAD_EXTERNAL_PROCESS="nns_logUploadExternalProcess",t.fn.vishnu.VishnuEvent.LOG_UPLOADED="nns_logUploaded",t.fn.vishnu.VishnuEvent.FORM_SHOW="nns_formShow",t.fn.vishnu.LCEModel=function(e){this.Vishnu=e},t.fn.vishnu.LCEModel.prototype={KIND_VISITOR:"visitor",KIND_OPERATOR:"operator",KIND_TEH:"info",Vishnu:null,Model:null,View:null,params:null,baseUrl:t.fn.vishnu.resourcesProvider.getBaseUrl(t.fn.vishnu._internalSettings.defaultBaseUrl),scriptLocation:null,scriptEvAdapterLocation:null,isLiveChatReady:!1,debugIntergtaion:!1,debugIntergtaionTime:2e3,operatorId:null,operatorAvatar:null,operatorName:null,operatorAlredyTyped:!1,dialogId:null,messageId:null,messageCount:0,lastMessage:null,transformDesignWidget:!0,sendLogWithRequiresOperator:!0,sendLogWithLCSessionCreate:!1,queueTimeout:3e4,queueTimer:null,restoreSession:!1,idOperatorName:"#vishnu-operatorName",TEHmessage:{noOperators:"К сожалению, все операторы заняты.",operatorIsTyped:"Печатает ",queueTime:"Оператор не взял диалог из очереди",operatorChange:"<img src='./images/success.png'>Диалог передан Оператору %NAME.",operatorProcess:"<img src='./images/circle_anim.gif'>Соединяю с оператором",dialogEnd:"Диалог с оператором завершён.",file:"Загружен файл: %FILE",log:"Для загрузки истории диалога перейдите по ссылке: %FILE"},savePrevTehMessage:!1,uploadEnable:!0,uploadPlugin:"uploadcare.min.js",idAttachFile:"",uploadcareId:"#vishnu-livechat-block",uploadcareTemplate:'<div id="vishnu-livechat-block"><div id="vishnu-livechat-off"><a href="#">Завершить диалог с оператором</a></div><div id="vishnu-attach-file-container"><input id="vishnu-attach-file" name="screenshot" type="hidden" role="uploadcare-uploader" data-crop="" data-tabs="file" data-public-key="%UPLOADCARE_PUBLIC_KEY" /></div><div id="vishnu-save-log"></div></div>',uploadcare:null,uploadcareWidgets:null,showRateBeforeQuit:!0,templateRateForLiveChat:'<div id="vishnu-livechat-rate">Диалог завершён. Оцените работу оператора по 10-бальной шкале.<div id="vishnu-livechat-rate-details"><a href="#" rel="0">0</a><a href="#" rel="1">1</a><a href="#" rel="2">2</a><a href="#" rel="3">3</a><a href="#" rel="4">4</a><a href="#" rel="5">5</a><a href="#" rel="6">6</a><a href="#" rel="7">7</a><a href="#" rel="8">8</a><a href="#" rel="9">9</a><a href="#" rel="10">10</a></div><textarea placeholder="Пожалуйста, напишите, почему вы поставили именно эту оценку"></textarea><button type="button" class="vishnu-livechat-rate-send">Отправить</button><button type="button" class="vishnu-livechat-rate-cancel">Отмена</button><br clear="all"></div><div class="vishnu-empty-box"><p><br></p></div>',rateShown:!1,rateAnswered:!1,isInf:1,isInit:!1,isReady:!1,state:null,initAlreadySended:!1,init:function(e){for(var n in e)n in this&&(this[n]=e[n]);var i=this;i.load(i.getScriptSource()),i.initEvents(),this.Vishnu.log("CSI: интеграционный модуль загружен и инициирован")},initEvents:function(){},setLiveChatDesign:function(e){var n=this.Vishnu.getView(),i=this;if(e){if(n.container.hasClass("vishnu-live-chat"))return;n.noCharacter=!0,n._stopAnimation(),n.container.addClass("vishnu-live-chat"),this.enabledUploadPlugin(),t("#vishnu-livechat-off > a",n.container).on("click",function(){i.debugIntergtaion&&console.log("ВЫЗВАНО:     "+t.fn.vishnu.VishnuEvent.USER_END_DIALOG),t(window).trigger(t.fn.vishnu.VishnuEvent.USER_END_DIALOG),t(window).trigger(t.fn.vishnu.VishnuEvent.RATE)}),t("#vishnu-save-log",n.container).on("click",function(){i.Vishnu.trigger(t.fn.vishnu.VishnuEvent.LOG_UPLOAD_EXTERNAL_PROCESS)})}else n.container.removeClass("vishnu-live-chat"),this.removeUploadPlugin(this.uploadcareId),n.noCharacter=!1,n._stopAnimation(),t("#vishnu-livechat-off > a",n.container).off("click"),t("#vishnu-save-log",n.container).off("click");n.updateHeight()},setOperatorAvatar:function(e){var n=this.Vishnu.getView();n._stopAnimation(),t(n.idView+"> img").length?t(n.idView+"> img").attr("src",e):t(n.idView).append('<img src="'+e+'" alt="" />')},setOperatorName:function(e){var n=this.Vishnu.getView();this.idOperatorName&&t(this.idOperatorName,n.container).length&&e&&t(this.idOperatorName,n.container).text(e)},removeUploadPlugin:function(e){var n=this.Vishnu.getView();t(e,n.container).length&&t(e,n.container).remove()},enabledUploadPlugin:function(){},onMessage:function(e){switch(this.lastMessage=e.message,this.messageCount++,e.kind){case this.KIND_VISITOR:this.onUserMessage(e);break;case this.KIND_OPERATOR:this.onPersonMessage(e),$history=this.Vishnu.getHistory(),$history.response({id:"from_CSI",text:{value:e.message}});break;default:this.onInfoMessage(e)}},onInfoMessage:function(e){$view=this.Vishnu.getView(),$view.addTehMessage(e.message,10,this.savePrevTehMessage),this.savePrevTehMessage=!1},onUserMessage:function(e){$view=this.Vishnu.getView(),$view.addUserMessage(e.message,10,e.file?"html":"")},onPersonMessage:function(e){$view=this.Vishnu.getView(),$view.addInfMessage(e.message)},onLiveChatReady:function(e){this.isLiveChatReady||(this.isLiveChatReady=!0)},getScriptSource:function(e){var n=e||this.scriptEvAdapterLocation;return null!==n?t.fn.vishnu.resourcesProvider.getCorrectScriptUrl(n,this.baseUrl):null},load:function(e){if(null!==e){var n=document.createElement("script");n.type="text/javascript",n.charset="utf-8",n.src=e,document.getElementsByTagName("head")[0].appendChild(n)}}}}("undefined"!=typeof vishnuJQuery?vishnuJQuery:jQuery),function(i){var e=i.fn.vishnu.LCEModel.prototype.initEvents;i.fn.vishnu.LCEModel.prototype.initEvents=function(){e.apply(this,arguments);var n=this;this.Vishnu.on(i.fn.vishnu.VishnuEvent.REQUIRES_OPERATOR,function(e){n.sendRequiresOperator()})},i.fn.vishnu.LCEModel.prototype.sendRequiresOperator=function(e){this.debugIntergtaion&&console.log("ПЕРЕХВАЧЕНО: "+i.fn.vishnu.VishnuEvent.REQUIRES_OPERATOR),this.isLiveChatReady||this.onLiveChatReady(),this.debugIntergtaion&&console.log("ВЫЗВАНО:     "+i.fn.vishnu.VishnuEvent.SWITCH_TO_OPERATOR_REQUESTED),i(window).trigger(i.fn.vishnu.VishnuEvent.SWITCH_TO_OPERATOR_REQUESTED),this.onMessage({message:this.TEHmessage.operatorProcess}),this.sendLogWithRequiresOperator&&!this.sendLogWithLCSessionCreate&&this.Vishnu.trigger(i.fn.vishnu.VishnuEvent.V3G_LOG_TO_OPERATOR_SENT),this.queueTimeout&&null!==this.queueTimeout&&(this.queueTimer=window.setTimeout(function(){i(window).trigger(i.fn.vishnu.VishnuEvent.USER_END_DIALOG),i(window).trigger(i.fn.vishnu.VishnuEvent.QUEUE_TIMED_OUT)},this.queueTimeout)),this.debugIntergtaion&&setTimeout(function(){var e=Math.round(6*Math.random()-.5),n=0<e;i(window).trigger(i.fn.vishnu.VishnuEvent.LIVECHAT_STATUS_REQUESTED,{hasOnlineOperators:n,freeOperatorsCount:e})},this.debugIntergtaionTime)}}("undefined"!=typeof vishnuJQuery?vishnuJQuery:jQuery),function(n){var e=n.fn.vishnu.LCEModel.prototype.initEvents;n.fn.vishnu.LCEModel.prototype.initEvents=function(){e.apply(this,arguments);var i=this;n(window).on(n.fn.vishnu.VishnuEvent.LIVECHAT_STATUS_REQUESTED,function(e,n){i.liveChatStatusRequested(n)})},n.fn.vishnu.LCEModel.prototype.liveChatStatusRequested=function(e){this.isLiveChatReady&&(this.debugIntergtaion&&console.log("ПЕРЕХВАЧЕНО: "+n.fn.vishnu.VishnuEvent.LIVECHAT_STATUS_REQUESTED+" DATA: ",e),!e||e.hasOnlineOperators&&0!==e.freeOperatorsCount?(this.Vishnu.trigger(n.fn.vishnu.VishnuEvent.V3G_LOG_TO_OPERATOR_SENT),this.debugIntergtaion&&setTimeout(function(){n(window).trigger(n.fn.vishnu.VishnuEvent.OPERATOR_PERSON_ASSIGNED,{operatorId:123456,operatorAvatar:"./images/avatar.png",operatorName:"Оператор (тест)",dialogId:654321})},this.debugIntergtaionTime)):(this.onMessage({message:this.TEHmessage.noOperators}),this.savePrevTehMessage=!0,this.debugIntergtaion&&console.log("ВЫЗВАНО:     "+n.fn.vishnu.VishnuEvent.SWITCH_TO_VISHNU),n(window).trigger(n.fn.vishnu.VishnuEvent.SWITCH_TO_VISHNU,{status:"noOperators"})))}}("undefined"!=typeof vishnuJQuery?vishnuJQuery:jQuery),function(e){var i=e.fn.vishnu.LCEModel.prototype.initEvents;e.fn.vishnu.LCEModel.prototype.initEvents=function(){i.apply(this,arguments);var n=this;e(window).on(e.fn.vishnu.VishnuEvent.SWITCH_TO_OPERATOR_SUCCESS,function(e){n.switchToOperatorSuccess()})},e.fn.vishnu.LCEModel.prototype.switchToOperatorSuccess=function(){this.isLiveChatReady&&(this.debugIntergtaion&&console.log("ПЕРЕХВАЧЕНО: "+e.fn.vishnu.VishnuEvent.SWITCH_TO_OPERATOR_SUCCESS),this.queueTimeout&&null!==this.queueTimeout&&null!==this.queueTimer&&(clearTimeout(this.queueTimer),this.queueTimer=null),this.transformDesignWidget&&(this.debugIntergtaion&&console.log("СОХРАНЕННЫЕ ДАННЫЕ ОПЕРАТОРА: ",this.operatorId,this.operatorAvatar,this.operatorName,this.dialogId),this.onMessage({message:this.TEHmessage.operatorChange.replace("%NAME",this.operatorName)}),this.setLiveChatDesign(!0),this.setOperatorAvatar(this.operatorAvatar),this.setOperatorName(this.operatorName)))}}("undefined"!=typeof vishnuJQuery?vishnuJQuery:jQuery),function(t){var e=t.fn.vishnu.LCEModel.prototype.initEvents;t.fn.vishnu.LCEModel.prototype.initEvents=function(){e.apply(this,arguments);var i=this;i.Vishnu.on(t.fn.vishnu.VishnuEvent.V3G_LOG_TO_OPERATOR_SENT,function(e,n){i.logToOperatorSent(n)})},t.fn.vishnu.LCEModel.prototype.logToOperatorSent=function(e){var n;this.debugIntergtaion&&console.log("ПЕРЕХВАЧЕНО: "+t.fn.vishnu.VishnuEvent.V3G_LOG_TO_OPERATOR_SENT+" DATA: ",e),n=this.Vishnu.History.get(),this.debugIntergtaion&&console.log("ВЫЗВАНО:     "+t.fn.vishnu.VishnuEvent.LOG_TO_OPERATOR_SENT+" DATA: ",n),t(window).trigger(t.fn.vishnu.VishnuEvent.LOG_TO_OPERATOR_SENT,n)}}("undefined"!=typeof vishnuJQuery?vishnuJQuery:jQuery);